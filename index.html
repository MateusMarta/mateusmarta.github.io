<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=yes">
		<meta name='description' content='Rankings das várias modalidades de bilhar, simulador de resultados e estatísticas com base nos resultados dos jogos individuais da Federação Portuguesa de Bilhar.'>
		<title>bilhar.top | Rankings, simulador e estatísticas de bilhar em Portugal</title>
		<link rel="shortcut icon" type="image/png" href="favicon.png">
		<p></p>
		<link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css" rel="stylesheet">
		<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
		<link rel="stylesheet" type="text/css" href="sheet.css">
		<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
		<body style="margin-bottom:1vh;">
		</head>
	
	<body>
	<div class="container">
	<p><a href="index.html">
					<img src="logo.png" alt="Home" width=230 height=85>
					<br>
					<i style="color:black"><small>Rankings de bilhar em Portugal</small></i>
				</a></p>
		<p></p>
	<input type="radio" name="Button" checked class="ButtonState" id="Button2" value="2" onclick="changeparagraph('poolPT');"/>
	<label class="Button" for="Button2">PoolPT</label>
	<input type="radio" name="Button" class="ButtonState" id="Button3" value="3" onclick="changeparagraph('pool');"/>
	<label class="Button" for="Button3">Pool</label>
	<input type="radio" name="Button" class="ButtonState" id="Button4" value="4" onclick="changeparagraph('carambola');"/>
	<label class="Button" for="Button4">Carambola</label>
	<input type="radio" name="Button" class="ButtonState" id="Button5" value="5" onclick="changeparagraph('snooker');"/>
	<label class="Button" for="Button5">Snooker</label>
	<p></p>
	<table id="table1" class="display" style="width:100%">
	<thead>
		<tr>
		<th></th>
		<th>Nome</th>
		<th>Rating</th>
		<th>Jogador 1</th>
		<th>Jogador 2</th>
		<th>Incerteza</th>
		<th>Licença FPB</th>
		</tr>
	</thead>
	</table>
        <p></p>
        <h2>
	Simulador de resultados
	</h2>
	<form>
		<div id="modalidade2">
		<b>Modalidade: </b>poolPT
		</div>
		<br>
		<div id="jogador_1">
		<b>Jogador 1: </b><i>Selecionar carregando no botão na tabela</i>
		</div>
		<br>
		<div id="jogador_2">
		<b>Jogador 2: </b><i>Selecionar carregando no botão na tabela</i>
		</div>
		<br>
		Primeiro a ganhar N jogos<br>
		<input id="k" type="text" name="k"><br>
		<br>
		<input type="button" value="Simular" onclick="prob_ganhar();" />
    	</form>
        <p></p>
	<div class="chart-container" id="chart-container"></div>
	<br>
	<div class="chart-container-2" id="chart-container-2"></div>
	<h2>
	<div id="modalidade">
	Estatísticas poolPT
	</div>
	</h2>
	<div class="chart-container-3" id="chart-container-3"></div>
        <p></p>
	</body>
	
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
	<script type="text/javascript" src="jquery.dataTables.min.js"></script>
	<script type="text/javascript" src="https://cdn.datatables.net/plug-ins/1.11.5/filtering/type-based/accent-neutralise.js"></script>
	
		
	<script>
	var r_a = 1;
	var r_b = 1;
	var i_a = 1;
	var i_b = 1;
	function changeparagraph(fa, primeiro=0) {
		$(document).ready(function() {
			if (primeiro==0){
			table.destroy();}
			var table = $('#table1').DataTable( {
				"ajax": 'json/'+fa+'.json',
				"deferRender": true,
				"lengthMenu": [ 10, 25, 50, 100 ],
				scrollX: true,
				columnDefs: [
					{ orderable: false, targets: [3,4]},
					{ sorting: false, targets: [3,4]},
					{"searchable": false, "targets": [2,5] },
					{
						targets: 4,
						data: null,
						defaultContent: '<button class="j2">Selecionar</button>',
					},
					{
						targets: 3,
						data: null,
						defaultContent: '<button class="j1">Selecionar</button>',
					},
				],
			} );
		} );
		
		$('#table1 tbody').on('click', 'button', function () {
			if (this.className == "j1"){
			var data = table.row($(this).parents('tr')).data();
			r_a = data[2];
			i_a = data[5];
			document.getElementById('jogador_1').innerHTML = "<b>Jogador 1: </b>" + data[1];
			}
			else {
			var data = table.row($(this).parents('tr')).data();
			r_b = data[2];
			i_b = data[5];   
			document.getElementById('jogador_2').innerHTML = "<b>Jogador 2: </b>" + data[1];
			} 
		});
		
		fetch("json/ets/"+fa+".json").then(
			function(u){ return u.json();}
	      		).then(
			function(json){
		  	  var xValues = [];
			  var yValues = [];
			  for(let i = 0; i<15; i++){xValues.push(json["bins"][i]);}
			  for(let i = 0; i<15; i++){yValues.push(json["histo"][i]);}
			  document.getElementById("chart-container-3").innerHTML = '&nbsp;';
			  document.getElementById("chart-container-3").innerHTML = '<canvas id="myChart-3"></canvas>';
			  new Chart("myChart-3", {
		type: "bar",
					data: {
						labels: xValues,
						datasets: [{
						data: yValues
						}]
					},
					options: {
						scales: {
					y: {
					    beginAtZero: true,

					}
				    },
			plugins: {
							legend: false,
							title: {display: true, text: "Distribuição de ratings (número de jogadores)" }
						}
					}
					});
			}
	      	)
		
		document.getElementById('modalidade').innerHTML = "Estatísticas " + fa;
		document.getElementById('modalidade2').innerHTML = "<b>Modalidade: </b>" + fa;
	};
	
	changeparagraph("poolPT",1);

  	function factorial(num)
	{
		var rval=1;
		for (var i = 2; i <= num; i++)
			rval = rval * i;
		return rval;
	}
	function combs(a, b){
		return factorial(a)/(factorial(b)*factorial(a-b));
	}
	function prob_ganhar() {
	var xValues = [];
	var yValues = [];
	var barColors = [];
	var k = document.getElementById('k').value;
	var p = 1/(1+Math.exp((r_b-r_a)/Math.sqrt(i_a**2+i_b**2)));
	var p_perder = 0;
	for(var r=0; r<k; r++){
		var prob = (p)**k * (1-p)**r * combs(parseFloat(k)+parseFloat(r)-1, r);
		xValues.push(k+"-"+r);
		yValues.push(Math.round((prob)*1000)/10);
		barColors.push("green");
	}
	for(var r=k-1; r>-1; r--){
		var prob = (1-p)**k * p**r * combs(parseFloat(k)+parseFloat(r)-1, r);
		xValues.push(r+"-"+k);
		yValues.push(Math.round((prob)*1000)/10);
		barColors.push("red");
		p_perder = p_perder + prob;
	}
	  document.getElementById("chart-container").innerHTML = '&nbsp;';
	  document.getElementById("chart-container").innerHTML = '<canvas id="myChart"></canvas>';
	  new Chart("myChart", {
		type: "bar",
		data: {
			labels: xValues,
			datasets: [{
			backgroundColor: barColors,
			data: yValues
			}]
		},
		options: {
			scales: {
                y: {
                    beginAtZero: true,

                }
            },
			plugins: {
				legend: false,
				title: {display: true, text: "Probabilidade de cada resultado (%)" }
			}
		}
		});
	  document.getElementById("chart-container-2").innerHTML = '&nbsp;';
	  document.getElementById("chart-container-2").innerHTML = '<canvas id="myChart-2"></canvas>';
	  new Chart("myChart-2", {
		type: "bar",
		data: {
			labels: ["Jogador 1", "Jogador 2"],
			datasets: [{
			backgroundColor: ["green", "red"],
			data: [Math.round((1-p_perder)*1000)/10, Math.round((p_perder)*1000)/10]
			}]
		},
		options: {
			scales: {
                y: {
                    beginAtZero: true,

                }
            },
			plugins: {
				legend: false,
				title: {display: true, text: "Probabilidade total de ganhar (%)" }
			}
		}
		});
          }
	
  </script>
</html>
